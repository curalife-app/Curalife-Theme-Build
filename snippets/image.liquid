{% comment %}
  Optimized Shopify CDN Responsive Image Component

  Accepts:
  - image: The main image object (required)
  - mobile_image: An optional image object for mobile devices
  - sizes: Custom sizes attribute (optional, default provided)
  - breakpoint: Custom breakpoint in pixels (optional, default: 768)
  - alt: Alt text for the image (required for accessibility)
  - class: Additional CSS classes (optional)

  Usage:
  {% render 'shopify-cdn-image',
    image: product.featured_image,
    mobile_image: product.images[1],
    sizes: '(min-width: 1200px) 1100px, (min-width: 769px) 750px, 100vw',
    breakpoint: 768,
    alt: product.title,
    class: 'my-custom-class'
  %}
{% endcomment %}

{%- liquid
  assign desktop_image = image
  assign mobile_image = mobile_image | default: image
  assign breakpoint = breakpoint | default: 768
  assign sizes = sizes | default: '(min-width: 1200px) 1100px, (min-width: 769px) 750px, 100vw'

  assign widths = '375,750,1080,1500,2200,3000'
  assign widths_array = widths | split: ','

  assign unique_id = 'img-' | append: desktop_image.id | append: '-' | append: mobile_image.id

  assign desktop_is_2x = desktop_image.src contains '2x'
  assign mobile_is_2x = mobile_image.src contains '2x'

  assign desktop_width = desktop_image.width
  assign desktop_height = desktop_image.height
  assign mobile_width = mobile_image.width
  assign mobile_height = mobile_image.height

  if desktop_is_2x
    assign desktop_width = desktop_width | divided_by: 2
    assign desktop_height = desktop_height | divided_by: 2
  endif
  if mobile_is_2x
    assign mobile_width = mobile_width | divided_by: 2
    assign mobile_height = mobile_height | divided_by: 2
  endif
-%}

<picture class="responsive-image-wrapper">
  <source
    media="(max-width: {{ breakpoint }}px)"
    srcset="
      {%- for width in widths_array -%}
        {{ mobile_image | image_url: width: width }} {{ width }}w{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    "
    sizes="{{ sizes }}"
  >
  <source
    media="(min-width: {{ breakpoint | plus: 1 }}px)"
    srcset="
      {%- for width in widths_array -%}
        {{ desktop_image | image_url: width: width }} {{ width }}w{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    "
    sizes="{{ sizes }}"
  >

  <img
    id="{{ unique_id }}"
    src="{{ desktop_image | image_url: width: 10 }}"
    data-src="{{ desktop_image | image_url: width: desktop_width }}"
    srcset="{{ desktop_image | image_url: width: 10 }}"
    data-srcset="
      {{ desktop_image | image_url: width: desktop_width }} 1x,
      {{ desktop_image | image_url: width: desktop_width | times: 2 }} 2x
    "
    alt="{{ alt | escape }}"
    width="{{ desktop_width }}"
    height="{{ desktop_height }}"
    class="responsive-image {% if class %}{{ class }}{% endif %}"
    loading="lazy"
  >
</picture>