{% if customer.email contains 'yotam' %}
{% comment %}Debug logs will be wrapped in HTML comments{% endcomment %}

<!-- DEBUG: Component Start -->
<!-- Input Parameters:
  image: {{ image.src }}
  mobile_image: {{ mobile_image.src | default: 'not provided' }}
  sizes: {{ sizes | default: 'default' }}
  breakpoint: {{ breakpoint | default: '768' }}
  lazy: {{ lazy | default: 'true' }}
  alt: {{ alt }}
  class: {{ class | default: 'none' }}
  link: {{ link | default: 'none' }}
-->

<!-- DEBUG: Component Start -->
{%- liquid
assign desktop_image = image
assign mobile_image = mobile_image | default: image

# Auto-detect retina images based on filename
assign full_path = desktop_image.src
assign path_parts = full_path | split: '/'
assign filename = path_parts | last
assign image_name = filename | split: '.' | first
assign image_ext = filename | split: '.' | last
assign retina_src = image_name | append: '-x2.' | append: image_ext
assign retina_check = retina_src | file_url

echo '<!-- DEBUG: Desktop Image Detection'
echo '  Original image src: ' | append: desktop_image.src
echo '  Filename: ' | append: filename
echo '  Image name: ' | append: image_name
echo '  Image extension: ' | append: image_ext
echo '  Looking for retina at: ' | append: retina_src
echo '  Retina check URL: ' | append: retina_check
echo '-->'

assign retina_image = nil
unless retina_check == blank
  assign retina_image = retina_src
  echo '<!-- DEBUG: Retina image found: ' | append: retina_src | append: ' -->'
else
  echo '<!-- DEBUG: No retina image found for desktop -->'
endif

# Auto-detect mobile retina image if mobile image is different
assign mobile_retina_image = nil
if mobile_image != desktop_image
  assign mobile_full_path = mobile_image.src
  assign mobile_path_parts = mobile_full_path | split: '/'
  assign mobile_filename = mobile_path_parts | last
  assign mobile_image_name = mobile_filename | split: '.' | first
  assign mobile_image_ext = mobile_filename | split: '.' | last
  assign mobile_retina_src = mobile_image_name | append: '-x2.' | append: mobile_image_ext
  assign mobile_retina_check = mobile_retina_src | file_url

  echo '<!-- DEBUG: Mobile Image Detection'
  echo '  Mobile image src: ' | append: mobile_image.src
  echo '  Mobile filename: ' | append: mobile_filename
  echo '  Mobile image name: ' | append: mobile_image_name
  echo '  Mobile image extension: ' | append: mobile_image_ext
  echo '  Looking for mobile retina at: ' | append: mobile_retina_src
  echo '  Mobile retina check URL: ' | append: mobile_retina_check
  echo '-->'

  unless mobile_retina_check == blank
    assign mobile_retina_image = mobile_retina_src
    echo '<!-- DEBUG: Mobile retina image found: ' | append: mobile_retina_src | append: ' -->'
  else
    echo '<!-- DEBUG: No retina image found for mobile -->'
  endunless
else
  assign mobile_retina_image = retina_image
  echo '<!-- DEBUG: Using desktop retina for mobile (same image) -->'
endif

assign lazy_load = lazy | default: true
assign breakpoint = breakpoint | default: 768
assign sizes = sizes | default: '(min-width: 1200px) 1100px, (min-width: 769px) 750px, 100vw'
assign link_url = link

# Define widths for regular displays
assign base_widths = '375,750,1080,1500,2200'
assign base_widths_array = base_widths | split: ','
assign unique_id = 'img-' | append: desktop_image.id | append: '-' | append: mobile_image.id

# Calculate the display dimensions
assign display_width = desktop_image.width
assign display_height = desktop_image.height

# Generate base URLs
assign base_url = desktop_image | image_url: width: 1100
assign mobile_base_url = mobile_image | image_url: width: 750

echo '<!-- DEBUG: Generated URLs'
echo '  Base desktop URL: ' | append: base_url
echo '  Base mobile URL: ' | append: mobile_base_url
echo '-->'

# Generate retina URLs if retina images are provided
if retina_image
  assign desktop_retina_url = retina_image | image_url: width: 2200
  echo '<!-- DEBUG: Generated desktop retina URL: ' | append: desktop_retina_url | append: ' -->'
endif

if mobile_retina_image
  assign mobile_retina_url = mobile_retina_image | image_url: width: 1500
  echo '<!-- DEBUG: Generated mobile retina URL: ' | append: mobile_retina_url | append: ' -->'
endif

echo '<!-- DEBUG: Final Configuration'
echo '  Unique ID: ' | append: unique_id
echo '  Display dimensions: ' | append: display_width | append: 'x' | append: display_height
echo '  Lazy loading: ' | append: lazy_load
echo '  Breakpoint: ' | append: breakpoint
echo '  Sizes: ' | append: sizes
echo '-->'
-%}

<div class="relative overflow-hidden">
{%- if link_url -%}
<!-- DEBUG: Adding link wrapper: {{ link_url }} -->
<a href="{{ link_url | escape }}">{%- endif -%}
<picture>
  {%- comment -%} Mobile Source {%- endcomment -%}
  <source
    media="(max-width: {{ breakpoint }}px)"
    srcset="
      {%- for width in base_widths_array -%}
        {{ mobile_image | image_url: width: width }} {{ width }}w
        {%- if mobile_retina_image -%}
          ,{{ mobile_retina_image | image_url: width: width | times: 2 }} {{ width | times: 2 }}w
        {%- endif -%}
        {%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    "
    sizes="{{ sizes }}"
  >
  <!-- DEBUG: Mobile srcset generated -->

  {%- comment -%} Desktop Source {%- endcomment -%}
  <source
    media="(min-width: {{ breakpoint | plus: 1 }}px)"
    srcset="
      {%- for width in base_widths_array -%}
        {{ desktop_image | image_url: width: width }} {{ width }}w
        {%- if retina_image -%}
          ,{{ retina_image | image_url: width: width | times: 2 }} {{ width | times: 2 }}w
        {%- endif -%}
        {%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    "
    sizes="{{ sizes }}"
  >
  <!-- DEBUG: Desktop srcset generated -->

  <img
    id="{{ unique_id }}"
    src="{{ base_url }}"
    {%- if retina_image -%}
    srcset="{{ desktop_retina_url }} 2x"
    {%- endif -%}
    {% if lazy_load %}loading="lazy"{% endif %}
    {% if lazy_load %}
      data-src="{{ base_url }}"
      data-srcset="
        {%- for width in base_widths_array -%}
          {{ desktop_image | image_url: width: width }} {{ width }}w
          {%- if retina_image -%}
            ,{{ retina_image | image_url: width: width | times: 2 }} {{ width | times: 2 }}w
          {%- endif -%}
          {%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      "
    {% endif %}
    alt="{{ alt | escape }}"
    width="{{ display_width }}"
    height="{{ display_height }}"
    class="block h-auto opacity-0 transition-opacity duration-300 ease-in-out {% if class %}{{ class }}{% endif %}"
    onload="this.classList.add('opacity-100');"
    data-original-url="{{ base_url }}"
    {%- if retina_image -%}
    data-desktop-retina-url="{{ desktop_retina_url }}"
    {%- endif -%}
    {%- if mobile_retina_image -%}
    data-mobile-retina-url="{{ mobile_retina_url }}"
    {%- endif -%}
  >
  <!-- DEBUG: Image element generated -->
</picture>
{%- if link_url -%}</a>{%- endif -%}
</div>
<!-- DEBUG: Component End -->
{% else %}
  {% comment %}
    Updated Shopify CDN Responsive Image Component

    Accepts:
    - image: The main image object (required)
    - mobile_image: An optional image object for mobile devices
    - sizes: Custom sizes attribute (optional, default provided)
    - breakpoint: Custom breakpoint in pixels (optional, default: 768)
    - lazy: Enable lazy loading (optional, default: true)
    - alt: Alt text for the image (required for accessibility)
    - class: Additional CSS classes (optional)
    - link: URL to wrap the image in a link (optional)

    Usage:
    {% render 'shopify-cdn-image',
      image: product.featured_image,
      mobile_image: product.images[1],
      sizes: '(min-width: 1200px) 1100px, (min-width: 769px) 750px, 100vw',
      breakpoint: 768,
      lazy: true,
      alt: product.title,
      class: 'my-custom-class',
      link: product.url
    %}
  {% endcomment %}

  {%- liquid
  assign desktop_image = image
  assign mobile_image = mobile_image | default: image
  assign lazy_load = lazy | default: true
  assign breakpoint = breakpoint | default: 768
  assign sizes = sizes | default: '(min-width: 1200px) 1100px, (min-width: 769px) 750px, 100vw'
  assign link_url = link
  assign widths = '375,750,1080,1500,2200,3000'
  assign widths_array = widths | split: ','
  assign unique_id = 'img-' | append: desktop_image.id | append: '-' | append: mobile_image.id
  assign image_extension = desktop_image.src | split: '.' | last | downcase

  # Check if filename contains X2 or x2
  assign filename = desktop_image.src | split: '/' | last
  assign is_x2 = false
  if filename contains 'X2' or filename contains 'x2'
    assign is_x2 = true
  endif

  # Calculate the display width and height
  assign display_width = desktop_image.width
  assign display_height = desktop_image.height
  if is_x2
    assign display_width = display_width | divided_by: 2
    assign display_height = display_height | divided_by: 2
  endif
  -%}

  <div class="responsive-image-wrapper contains">
  {%- if link_url -%}<a href="{{ link_url | escape }}">{%- endif -%}
  <picture>
    <source
      media="(max-width: {{ breakpoint }}px)"
      srcset="
        {%- for width in widths_array -%}
          {{ mobile_image | image_url: width: width }} {{ width }}w,
        {%- endfor -%}
      "
      sizes="{{ sizes }}">
    <source
      media="(min-width: {{ breakpoint | plus: 1 }}px)"
      srcset="
        {%- for width in widths_array -%}
          {{ desktop_image | image_url: width: width }} {{ width }}w,
        {%- endfor -%}
      "
      sizes="{{ sizes }}">

    <img
      id="{{ unique_id }}"
      src="{{ desktop_image | image_url: width: 1100 }}"
      srcset="{{ desktop_image | image_url: width: 2200 }} 2x"
      {% if lazy_load %}loading="lazy"{% endif %}
      {% if lazy_load %}
        data-src="{{ desktop_image | image_url: width: 1100 }}"
        data-srcset="
          {%- for width in widths_array -%}
            {{ desktop_image | image_url: width: width }} {{ width }}w,
          {%- endfor -%}
        "
      {% endif %}
      alt="{{ alt | escape }}"
      width="{{ display_width }}"
      height="{{ display_height }}"
      class="responsive-image relative {% if class %}{{ class }}{% endif %}"
      onload="this.classList.add('loaded');"
      href="{{ link_url }}"
      name="track:Image Link"
    >
  </picture>
  {%- if link_url -%}</a>{%- endif -%}
  </div>
{% endif %}