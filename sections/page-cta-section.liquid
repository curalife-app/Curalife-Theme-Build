{% assign prodReference = section.settings.product | default: product | default: all_products["curalin-pack"] %}
{% assign buyBoxColor = prodReference.metafields.custom.primary_color | default: section.settings.buy_box_color | default: page.metafields.primary_color | default: "var(--primary-color)" %}

{% if section.settings.anchor_id %}<div id="{{ section.settings.anchor_id }}"></div>{% endif %}

<section class="cta-section overflow-visible pb-0 {{ section.settings.additional_classes }}" id="cta-section-{{ section.id }}">
  {% render 'product-cta',
    ctaTemplate: section.settings.cta_template,
    bgColor: section.settings.bg_color,
    buyBoxColor: buyBoxColor,
    ctaColor: "var(--orange)",
    mainTitle: section.settings.main_title,
    title: section.settings.variants_title,
    ctaText: section.settings.cta_text,
    thumbnailImage: section.settings.thumbnail_image,
    thumbnailImageMobile: section.settings.thumbnail_image_mobile,
    pricePer: section.settings.price_per,
    saveFormat: section.settings.save_format,
    badgeImage: section.settings.badge_image,
    ctaTextType: section.settings.price_format,
    titleTag: section.settings.title_tag,
    isSubscription: section.settings.is_subscription,
    isReviews: section.settings.is_reviews,
    isHideThumbs: section.settings.is_hide_thumbs,
    isBuyWithPrime: section.settings.is_buy_with_prime,
    isVariantBoxToggle: section.settings.is_variant_toggle,
    buyType: section.settings.buy_type,
    prod: prodReference,
  %}
</section>

{% if section.settings.isPopup %}
  <div id="cta-popup-{{ section.id }}" class="cta-popup" style="display: none;">
    <div class="cta-popup-content">
      <button class="close-popup" aria-label="Close popup">&times;</button>
      <div class="cta-popup-inner">
        {% render 'product-cta',
          ctaTemplate: section.settings.cta_template,
          bgColor: section.settings.bg_color,
          buyBoxColor: buyBoxColor,
          ctaColor: "var(--orange)",
          mainTitle: section.settings.main_title,
          title: section.settings.variants_title,
          ctaText: section.settings.cta_text,
          thumbnailImage: section.settings.thumbnail_image,
          thumbnailImageMobile: section.settings.thumbnail_image_mobile,
          pricePer: section.settings.price_per,
          saveFormat: section.settings.save_format,
          badgeImage: section.settings.badge_image,
          ctaTextType: section.settings.price_format,
          titleTag: section.settings.title_tag,
          isSubscription: section.settings.is_subscription,
          isReviews: section.settings.is_reviews,
          isHideThumbs: section.settings.is_hide_thumbs,
          isBuyWithPrime: section.settings.is_buy_with_prime,
          isVariantBoxToggle: section.settings.is_variant_toggle,
          buyType: section.settings.buy_type,
          prod: prodReference,
        %}
      </div>
    </div>
  </div>
{% endif %}

<script>
  // Existing script for cart functionality (unchanged)

  {% if section.settings.isPopup %}
    document.addEventListener('DOMContentLoaded', function() {
      const popup = document.getElementById('cta-popup-{{ section.id }}');
      const togglePopup = (show) => {
        popup.style.display = show ? 'flex' : 'none';
        document.body.style.overflow = show ? 'hidden' : '';
      };

      document.querySelectorAll('a[href="#cta-popup"]').forEach(el =>
        el.addEventListener('click', (e) => {
          e.preventDefault();
          togglePopup(true);
        })
      );

      popup.querySelector('.close-popup').addEventListener('click', () => togglePopup(false));
      popup.addEventListener('click', (e) => {
        if (e.target === popup) togglePopup(false);
      });

      // Close popup on ESC key press
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && popup.style.display === 'flex') togglePopup(false);
      });
    });
  {% endif %}
</script>

{% if section.settings.isPopup %}
  <style>
    .cta-popup {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }
    .cta-popup-content {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      position: relative;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    .cta-popup-inner {
      max-height: calc(90vh - 60px);
      overflow-y: auto;
    }
    .close-popup {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 28px;
      background: none;
      border: none;
      cursor: pointer;
      color: #333;
      transition: color 0.3s ease;
    }
    .close-popup:hover {
      color: #000;
    }
    @media (max-width: 768px) {
      .cta-popup-content {
        padding: 20px;
        width: 95%;
      }
    }
  </style>
{% endif %}

{% schema %}
{
    "name": "CTA Section",
    "disabled_on": {
      "groups": [
        "header",
        "footer"
      ]
    },
    "settings": [
      {
        "type": "product",
        "id": "product",
        "label": "Product"
      },
      {
        "type": "select",
        "id": "cta_template",
        "label": "CTA Template",
        "options": [
          {
            "value": "basic",
            "label": "Basic"
          },
          {
            "value": "2024",
            "label": "Subscription"
          },
          {
            "value": "2024-new",
            "label": "Subscription New"
          },
          {
            "value": "2024-new-2",
            "label": "Subscription New 2"
          },
          {
            "value": "2024-new-3",
            "label": "Subscription New 3"
          }
        ],
        "default": "2024"
      },
      {
        "type": "color",
        "id": "bg_color",
        "label": "Background Color"
      },
      {
        "type": "color",
        "id": "buy_box_color",
        "label": "Buy Box Main Color",
        "default": "#3A7684"
      },
      {
        "type": "color",
        "id": "cta_color",
        "label": "CTA Color"
      },
      {
        "type": "text",
        "id": "main_title",
        "label": "Main Title"
      },
      {
        "type": "text",
        "id": "variants_title",
        "label": "Variants Title"
      },
      {
        "type": "richtext",
        "id": "cta_text",
        "label": "CTA Text"
      },
      {
        "type": "image_picker",
        "id": "thumbnail_image",
        "label": "Main Thumbnail Image"
      },
      {
        "type": "image_picker",
        "id": "thumbnail_image_mobile",
        "label": "Main Thumbnail Image on Mobile"
      },
      {
        "type": "image_picker",
        "id": "badge_image",
        "label": "Badge Image"
      },
      {
        "type": "select",
        "id": "buy_type",
        "label": "Buy Type",
        "options": [
          {
            "value": "add_to_cart",
            "label": "Add to Cart"
          },
          {
            "value": "buy_now",
            "label": "Buy Now"
          }
        ],
        "default": "add_to_cart"
      },
      {
        "type": "select",
        "id": "price_per",
        "label": "Price Per",
        "options": [
          {
            "value": "dont_split",
            "label": "Do not Split"
          },
          {
            "value": "month",
            "label": "Month"
          },
          {
            "value": "bottle",
            "label": "Bottle"
          }
        ],
        "default": "dont_split"
      },
      {
        "type": "select",
        "id": "save_format",
        "label": "Save Format",
        "options": [
          {
            "value": "percentage",
            "label": "Percentage"
          },
          {
            "value": "money",
            "label": "Money"
          }
        ],
        "default": "percentage"
      },
      {
        "type": "select",
        "id": "price_format",
        "label": "Price Format",
        "options": [
          {
            "value": "total",
            "label": "Total"
          },
          {
            "value": "save",
            "label": "Save"
          }
        ],
        "default": "total"
      },
      {
        "type": "select",
        "id": "title_tag",
        "label": "Title Tag",
        "options": [
          {
            "value": "h1",
            "label": "H1"
          },
          {
            "value": "h2",
            "label": "H2"
          }
        ],
        "default": "h1"
      },
      {
        "type": "number",
        "id": "default_selection_index",
        "label": "Default Selection Index",
        "default": 1
      },
      {
        "type": "checkbox",
        "id": "is_subscription",
        "label": "Is Subscription",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "is_highlight_subtitle",
        "label": "Is Highlight Subtitle"
      },
      {
        "type": "checkbox",
        "id": "is_reverse",
        "label": "Reverse Variants"
      },
      {
        "type": "checkbox",
        "id": "is_reviews",
        "label": "Show Reviews"
      },
      {
        "type": "checkbox",
        "id": "is_reviews_quotes",
        "label": "Show Reviews Quotes"
      },
      {
        "type": "checkbox",
        "id": "is_save_title",
        "label": "Show Save Title"
      },
      {
        "type": "checkbox",
        "id": "is_hide_thumbs",
        "label": "Is Hide Thumbs"
      },
      {
        "type": "checkbox",
        "id": "is_buy_quantity",
        "label": "Quantity Selector"
      },
      {
        "type": "checkbox",
        "id": "is_variant_toggle",
        "label": "Variant Box Toggle"
      },
      {
        "type": "checkbox",
        "id": "is_buy_with_prime",
        "label": "Show Buy with Prime"
      },
      {
        "type": "checkbox",
        "id": "isPopup",
        "label": "Display as Popup",
        "default": false
      },
      {
        "type": "text",
        "id": "anchor_id",
        "label": "Anchor ID"
      },
      {
        "type": "text",
        "id": "additional_classes",
        "label": "Additional Classes"
      }
    ],
    "blocks": [
      {
        "type": "image",
        "name": "Image",
        "settings": [
          {
            "type": "image_picker",
            "id": "product_img",
            "label": "Product Image"
          }
        ]
      },
      {
        "type": "video",
        "name": "Video",
        "settings": [
          {
            "type": "text",
            "id": "vimeo_video_id",
            "label": "Vimeo Video ID"
          },
          {
            "type": "image_picker",
            "id": "video_thumbnail",
            "label": "Video Thumbnail"
          }
        ]
      }
    ],
    "presets": [
    {
        "name": "CTA Section"
    }
  ]
}
{% endschema %}