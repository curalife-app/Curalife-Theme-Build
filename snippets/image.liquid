{% comment %}
  Responsive Image Component for Shopify

  Accepts:
  - image: The main image object (required)
  - mobile_image: An optional image object for mobile devices
  - sizes: Custom sizes attribute (optional, default provided)
  - breakpoint: Custom breakpoint in pixels (optional, default: 768)
  - lazy: Enable lazy loading (optional, default: true)
  - preload: Preload the image (optional, default: false)
  - alt: Alt text for the image (required for accessibility)
  - class: Additional CSS classes (optional)

  Usage:
  {% render 'responsive-image',
    image: product.featured_image,
    mobile_image: product.images[1],
    sizes: '(min-width: 1200px) 1100px, (min-width: 769px) 750px, 100vw',
    breakpoint: 768,
    lazy: true,
    preload: false,
    alt: product.title,
    class: 'my-custom-class'
  %}
{% endcomment %}

{%- liquid
  assign desktop_image = image
  assign mobile_image = mobile_image | default: image
  assign lazy_load = lazy | default: true
  assign preload_image = preload | default: false
  assign breakpoint = breakpoint | default: 768
  assign sizes = sizes | default: '(min-width: 1200px) 1100px, (min-width: 769px) 750px, 100vw'

  assign mobile_widths = '375,750,1080,1500'
  assign desktop_widths = '750,1100,1500,2200,3000'

  assign mobile_widths_array = mobile_widths | split: ','
  assign desktop_widths_array = desktop_widths | split: ','

  assign unique_id = 'img-' | append: desktop_image.id | append: '-' | append: mobile_image.id
-%}

{% if preload_image %}
  <link rel="preload" as="image" href="{{ desktop_image | img_url: '1100x' }}" imagesrcset="
    {%- for width in desktop_widths_array -%}
      {{ desktop_image | img_url: width | append: 'x' }} {{ width }}w,
    {%- endfor -%}
  " imagesizes="{{ sizes }}">
{% endif %}

<div class="responsive-image-wrapper" style="aspect-ratio: {{ desktop_image.aspect_ratio }}; background-color: {{ desktop_image.dominant_color | default: '#f0f0f0' }};">
  <picture>
    {%- if settings.enable_webp -%}
      <source
        type="image/webp"
        media="(max-width: {{ breakpoint }}px)"
        srcset="
          {%- for width in mobile_widths_array -%}
            {{ mobile_image | img_url: width | append: 'x.webp' }} {{ width }}w,
          {%- endfor -%}
        "
        sizes="{{ sizes }}"
      >
      <source
        type="image/webp"
        media="(min-width: {{ breakpoint | plus: 1 }}px)"
        srcset="
          {%- for width in desktop_widths_array -%}
            {{ desktop_image | img_url: width | append: 'x.webp' }} {{ width }}w,
          {%- endfor -%}
        "
        sizes="{{ sizes }}"
      >
    {%- endif -%}

    <source
      media="(max-width: {{ breakpoint }}px)"
      srcset="
        {%- for width in mobile_widths_array -%}
          {{ mobile_image | img_url: width | append: 'x' }} {{ width }}w,
        {%- endfor -%}
      "
      sizes="{{ sizes }}"
    >
    <source
      media="(min-width: {{ breakpoint | plus: 1 }}px)"
      srcset="
        {%- for width in desktop_widths_array -%}
          {{ desktop_image | img_url: width | append: 'x' }} {{ width }}w,
        {%- endfor -%}
      "
      sizes="{{ sizes }}"
    >

    <img
      id="{{ unique_id }}"
      src="{{ desktop_image | img_url: '1100x' }}"
      srcset="{{ desktop_image | img_url: '2200x' }} 2x"
      {% if lazy_load and preload_image == false %}loading="lazy"{% endif %}
      {% if lazy_load and preload_image == false %}
        data-src="{{ desktop_image | img_url: '1100x' }}"
        data-srcset="
          {%- for width in desktop_widths_array -%}
            {{ desktop_image | img_url: width | append: 'x' }} {{ width }}w,
          {%- endfor -%}
        "
      {% endif %}
      alt="{{ alt | escape }}"
      width="{{ desktop_image.width }}"
      height="{{ desktop_image.height }}"
      class="responsive-image {% if class %}{{ class }}{% endif %}"
      style="width: 100%; height: 100%; object-fit: cover;"
      onload="this.style.backgroundColor='transparent';"
    >
  </picture>
</div>

{% if lazy_load and preload_image == false %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var lazyImageObserver = new IntersectionObserver(function(entries, observer) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            let lazyImage = entry.target;
            lazyImage.src = lazyImage.dataset.src;
            lazyImage.srcset = lazyImage.dataset.srcset;
            lazyImage.classList.add('loaded');
            lazyImageObserver.unobserve(lazyImage);
          }
        });
      }, {
        rootMargin: '0px 0px 300px 0px'
      });

      document.querySelectorAll('img[data-src]').forEach(function(lazyImage) {
        lazyImageObserver.observe(lazyImage);
      });
    });
  </script>
{% endif %}

<style>
  .responsive-image-wrapper {
    overflow: hidden;
    position: relative;
  }
  .responsive-image {
    transition: opacity 0.3s ease-in-out;
  }
  .responsive-image:not(.loaded) {
    opacity: 0;
  }
  .responsive-image.loaded {
    opacity: 1;
  }
</style>