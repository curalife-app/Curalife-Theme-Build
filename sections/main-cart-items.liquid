<!-- Improved Shopify Cart with Modern Features -->
<script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>

<style>
  .cart-container {
    max-width: 1400px;
    margin: 2rem auto;
    font-family: system-ui, -apple-system, sans-serif;
    background: #fff;
    border-radius: 1rem;
    opacity: 1;
    transition: opacity 0.3s ease;
  }

  .cart-container.loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .cart-progress {
    margin: 1rem 1.5rem;
    padding: 1rem;
    background: #f3f4f6;
    border-radius: 0.5rem;
    text-align: center;
  }

  .progress-bar {
    height: 0.5rem;
    background: #e5e7eb;
    border-radius: 0.25rem;
    margin: 0.5rem 0;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
  }

  .cart-table {
    width: 100%;
    border-spacing: 0;
    padding: 1.5rem;
  }

  .cart-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .product-image img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 0.5rem;
  }

  .quantity-input {
    display: inline-flex;
    align-items: center;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .quantity-btn {
    padding: 0.5rem;
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
  }

  .quantity-btn:hover {
    background: #f3f4f6;
  }

  .quantity-input input {
    width: 3rem;
    text-align: center;
    border: none;
    border-left: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
    padding: 0.5rem;
  }

  .cart-summary {
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 0 0 1rem 1rem;
  }

  .checkout-button {
    width: 100%;
    padding: 1rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: background-color 0.2s;
  }

  .checkout-button:hover {
    background: #2563eb;
  }

  .cart-empty {
    text-align: center;
    padding: 4rem 2rem;
  }

  .notification {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    padding: 1rem;
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(100%);
    animation: slideIn 0.3s forwards;
  }

  @keyframes slideIn {
    to { transform: translateY(0); }
  }

  @media (max-width: 768px) {
    .cart-table thead { display: none; }
    .cart-table td {
      display: grid;
      grid-template-columns: 1fr auto;
      padding: 0.75rem;
      gap: 0.5rem;
    }
    .product-image { grid-column: 1/-1; }
  }
</style>

<div class="cart-container">
  <cart-items>
    <div class="cart-header">
      <h1>Cart ({{ cart.item_count }})</h1>
      <a href="{{ routes.all_products_collection_url }}">Continue Shopping</a>
    </div>

    {% if cart.total_price > 0 %}
      <div class="cart-progress">
        {% assign free_shipping_threshold = 7500 %}
        {% assign progress = cart.total_price | times: 100 | divided_by: free_shipping_threshold %}
        <p>
          {% if progress >= 100 %}
            You've got free shipping! ðŸŽ‰
          {% else %}
            Add {{ free_shipping_threshold | minus: cart.total_price | money }} for free shipping
          {% endif %}
        </p>
        <div class="progress-bar">
          <div class="progress-bar-fill" style="width: {{ progress }}%"></div>
        </div>
      </div>
    {% endif %}

    {% if cart == empty %}
      <div class="cart-empty">
        <h2>Your cart is empty</h2>
        <a href="{{ routes.all_products_collection_url }}" class="checkout-button">Start Shopping</a>
      </div>
    {% else %}
      <form action="{{ routes.cart_url }}" method="post" id="cart">
        <table class="cart-table">
          <tbody>
            {% for item in cart.items %}
              <tr>
                <td class="product-image">
                  <img src="{{ item.image | img_url: '160x160', crop: 'center' }}"
                       alt="{{ item.title | escape }}"
                       loading="lazy">
                </td>
                <td>
                  <a href="{{ item.url }}">{{ item.title }}</a>
                  {% if item.selling_plan_allocation %}
                    <p>{{ item.selling_plan_allocation.selling_plan.name }}</p>
                  {% endif %}
                </td>
                <td>
                  <div class="quantity-input">
                    <button type="button" class="quantity-btn" data-action="decrease">-</button>
                    <input type="number" name="updates[]" value="{{ item.quantity }}" min="0"
                           aria-label="Quantity for {{ item.title | escape }}">
                    <button type="button" class="quantity-btn" data-action="increase">+</button>
                  </div>
                </td>
                <td>{{ item.final_line_price | money }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="cart-summary">
          <p><span>Subtotal</span> <span>{{ cart.total_price | money }}</span></p>
          {% if cart.total_discount > 0 %}
            <p><span>Savings</span> <span>-{{ cart.total_discount | money }}</span></p>
          {% endif %}
          <button type="submit" name="checkout" class="checkout-button">
            Checkout â€¢ {{ cart.total_price | money }}
          </button>
        </div>
      </form>
    {% endif %}
  </cart-items>
</div>

{% schema %}
{
  "name": "Cart Items",
  "settings": [
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Free Shipping Threshold",
      "default": 7500
    }
  ]
}
{% endschema %}