<section class="capsule-animation-section">
  <div class="container">
    <div class="view capsule-animation">
      <div class="pill relative flex justify-center">
        <img class="pill-half left mbl:w-2/3 m-0" src="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/pill-half.png?v=1723722706" alt="Curaslim 2024 Capsule Animation Pill Half">
        <img class="pill-half right mbl:w-2/3 m-0" src="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/pill_R.png?v=1724077162" alt="Curaslim 2024 Capsule Animation Pill Half">
      </div>

      <div class="fallen-items">
        <picture class="fallen-item">
            <source media="(max-width: 768px)" srcset="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/3_Control_Craving_Portion_Mobile.png">
            <img src="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/3_Control_Craving_Portion.png" alt="curaslim ingredients benefits">
        </picture>
        <picture class="fallen-item">
            <source media="(max-width: 768px)" srcset="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/3_Control_Craving_Portion3_Mobile.png">
            <img src="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/3_Control_Craving_Portion3.png" alt="curaslim ingredients benefits">
        </picture>
        <picture class="fallen-item">
            <source media="(max-width: 768px)" srcset="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/3_Control_Craving_Portion2_Mobile.png">
            <img src="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/3_Control_Craving_Portion2.png" alt="curaslim ingredients benefits">
        </picture>
      </div>

      <img class="powder" src="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/powder.png?v=1724075423" alt="Curaslim 2024 Capsule Animation Powder">

      <div class="confetti-container"></div>
    </div>
  </div>
</section>

<style>
    main {
        overflow: clip !important;
    }

    .capsule-animation-section {
        overflow: clip !important;
    }

    .capsule-animation {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: start;
        min-height: 800px;
    }

    .pill {
        position: relative;
        z-index: 2;
    }

    .pill-half {
        transition: transform 1s ease-out;
        will-change: transform;
    }

    .pill-half.left {
        transform: translateX(5px) rotate(0deg);
    }

    .pill-half.right {
        transform: translateX(-5px) rotate(0deg);
    }

    .powder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: -1;
        opacity: 0;
        transition: opacity 1s ease-out;
    }

    .fallen-items {
        position: absolute;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
        width: 300px;
        height: 300px;
    }

    .fallen-item {
        position: absolute;
        opacity: 0;
        transition: all 1.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        will-change: transform, opacity;
    }

    .confetti-container {
        position: absolute;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        height: 300px;
        pointer-events: none;
    }

    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #f0f0f0;
        opacity: 0;
        will-change: transform, opacity;
    }

    @media (max-width: 768px) {
        .capsule-animation {
            min-height: 600px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('.capsule-animation-section');
    const pillLeft = section.querySelector('.pill-half.left');
    const pillRight = section.querySelector('.pill-half.right');
    const powder = section.querySelector('.powder');
    const fallenItems = section.querySelectorAll('.fallen-item');
    const confettiContainer = section.querySelector('.confetti-container');

    const confettiColors = ['#0F7CBF', '#FFCB5E', '#FFB22D', '#c2c195', '#FFEBCD'];
    const confettiShapes = ['circle', 'square', 'triangle', 'rectangle'];

    let animationCompleted = false;

    function createConfetti() {
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti');

            const color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
            const shape = confettiShapes[Math.floor(Math.random() * confettiShapes.length)];
            const size = Math.random() * 8 + 4;

            confetti.style.backgroundColor = color;
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size}px`;

            if (shape === 'circle') {
                confetti.style.borderRadius = '50%';
            } else if (shape === 'triangle') {
                confetti.style.width = '0';
                confetti.style.height = '0';
                confetti.style.backgroundColor = 'transparent';
                confetti.style.borderLeft = `${size/2}px solid transparent`;
                confetti.style.borderRight = `${size/2}px solid transparent`;
                confetti.style.borderBottom = `${size}px solid ${color}`;
            } else if (shape === 'rectangle') {
                confetti.style.height = `${size * 1.5}px`;
            }

            confettiContainer.appendChild(confetti);
        }
    }

    function animateConfetti() {
        const confetti = confettiContainer.querySelectorAll('.confetti');
        confetti.forEach(c => {
            const fallX = (Math.random() - 0.5) * 600;
            const fallY = Math.random() * 800 + 400;
            const rotation = Math.random() * 720 - 360;
            const delay = Math.random() * 0.5;

            c.style.transition = `transform 2s ease-out ${delay}s, opacity 2s ease-out ${delay}s`;
            c.style.transform = `translate(${fallX}px, ${fallY}px) rotate(${rotation}deg)`;
            c.style.opacity = 0;
        });
    }

    function animateOnScroll() {
        if (animationCompleted) return;

        const rect = section.getBoundingClientRect();
        const sectionTop = rect.top;
        const sectionHeight = rect.height;
        const windowHeight = window.innerHeight;
        const scrollPercentage = Math.max(0, Math.min(1, (windowHeight - sectionTop) / (windowHeight + sectionHeight)));

        if (scrollPercentage > 0.3) {
            const openingPercentage = (scrollPercentage - 0.3) / 0.7;
            const rotateAngle = 30 * openingPercentage;
            const translateX = 50 * openingPercentage;

            pillLeft.style.transform = `translateX(${-translateX}%) rotate(${rotateAngle}deg)`;
            pillRight.style.transform = `translateX(calc(-10px + ${translateX}%)) rotate(${-rotateAngle}deg)`;
            powder.style.opacity = openingPercentage;

            const isMobile = window.innerWidth <= 768;
            const finalPositions = isMobile
                ? [
                    { x: '0%', y: '350px' },
                    { x: '0%', y: '450px' },
                    { x: '0%', y: '230px' }
                  ]
                : [
                    { x: '-60%', y: '270px' },
                    { x: '0%', y: '380px' },
                    { x: '50%', y: '200px' }
                  ];

            fallenItems.forEach((item, index) => {
                const delay = index * 0.2;
                const { x, y } = finalPositions[index];
                item.style.transition = `all 1.5s cubic-bezier(0.25, 0.1, 0.25, 1) ${delay}s`;
                item.style.transform = `translate(${x}, ${y})`;
                item.style.opacity = 1;
            });

            if (openingPercentage > 0.5 && !confettiContainer.classList.contains('animated')) {
                confettiContainer.classList.add('animated');
                animateConfetti();
            }

            if (openingPercentage >= 1) {
                animationCompleted = true;
                window.removeEventListener('scroll', animateOnScroll);
            }
        }
    }

    createConfetti();
    window.addEventListener('scroll', animateOnScroll);
    animateOnScroll(); // Initial call to set starting positions

    // Re-run animation on window resize to adjust for mobile/desktop layouts
    window.addEventListener('resize', () => {
        animationCompleted = false;
        animateOnScroll();
    });
});
</script>

{% schema %}
  {
    "name": "Capsule Animation",
    "settings": [],
    "presets": [
      {
        "category": "Page",
        "name": "Capsule Animation"
      }
    ]
  }
{% endschema %}