{%- comment -%}
  Phase 2C: Optimized Lazy Loading Implementation
  Features:
  - Intersection Observer API for performance
  - Responsive image loading
  - Modern format fallbacks (AVIF → WebP → original)
  - Fade-in animation
  - SEO-friendly with proper alt attributes
{%- endcomment -%}

{%- liquid
  assign loading = loading | default: 'lazy'
  assign sizes = sizes | default: '100vw'
  assign fade_in = fade_in | default: true
  assign threshold = threshold | default: '50px'
-%}

<div class="lazy-image-container{% if fade_in %} fade-in{% endif %}"
     data-threshold="{{ threshold }}">
  <picture>
    {%- if avif_src -%}
      <source srcset="{{ avif_src }}" type="image/avif">
    {%- endif -%}
    {%- if webp_src -%}
      <source srcset="{{ webp_src }}" type="image/webp">
    {%- endif -%}
    <img src="{{ placeholder | default: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB2aWV3Qm94PSIwIDAgMSAxIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNGM0Y0RjYiLz48L3N2Zz4=' }}"
         data-src="{{ src }}"
         {%- if responsive_srcset %}data-srcset="{{ responsive_srcset }}"{% endif -%}
         {%- if sizes %}data-sizes="{{ sizes }}"{% endif -%}
         alt="{{ alt | escape }}"
         class="lazy-image {{ class }}"
         loading="{{ loading }}"
         decoding="async"
         {%- if width %}width="{{ width }}"{% endif -%}
         {%- if height %}height="{{ height }}"{% endif -%}>
  </picture>
</div>

<style>
.lazy-image-container {
  display: block;
  overflow: hidden;
}

.lazy-image {
  transition: opacity 0.3s ease-in-out;
  opacity: 0;
}

.lazy-image.loaded {
  opacity: 1;
}

.lazy-image-container.fade-in .lazy-image {
  opacity: 1;
}

.lazy-image-container[data-loading="true"]::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
// Phase 2C: Advanced Lazy Loading with Intersection Observer
(function() {
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const container = entry.target;
          const img = container.querySelector('.lazy-image');

          if (img && img.dataset.src) {
            // Set loading state
            container.dataset.loading = 'true';

            // Load the image
            const tempImg = new Image();
            tempImg.onload = () => {
              // Update src and srcset
              img.src = img.dataset.src;
              if (img.dataset.srcset) {
                img.srcset = img.dataset.srcset;
              }
              if (img.dataset.sizes) {
                img.sizes = img.dataset.sizes;
              }

              // Mark as loaded
              img.classList.add('loaded');
              container.dataset.loading = 'false';

              // Clean up data attributes
              delete img.dataset.src;
              delete img.dataset.srcset;
              delete img.dataset.sizes;
            };

            tempImg.onerror = () => {
              container.dataset.loading = 'false';
              console.warn('Failed to load image:', img.dataset.src);
            };

            tempImg.src = img.dataset.src;
            observer.unobserve(container);
          }
        }
      });
    }, {
      rootMargin: '{{ threshold | default: "50px" }}'
    });

    // Observe all lazy image containers
    document.querySelectorAll('.lazy-image-container').forEach(container => {
      imageObserver.observe(container);
    });
  } else {
    // Fallback for browsers without Intersection Observer
    document.querySelectorAll('.lazy-image').forEach(img => {
      if (img.dataset.src) {
        img.src = img.dataset.src;
        if (img.dataset.srcset) img.srcset = img.dataset.srcset;
        if (img.dataset.sizes) img.sizes = img.dataset.sizes;
        img.classList.add('loaded');
      }
    });
  }
})();
</script>