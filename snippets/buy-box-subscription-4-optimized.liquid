{% assign isGlobal = false %}
{% if shop.name contains 'Global' %}
	{% assign isGlobal = true %}
{% endif %}

{% if prod.handle == 'curalin' or prod.handle == 'curaslim' or prod.handle contains '-tm' %}
	{% if isGlobal %}
		{% assign shippingPrice = 690 %}
	{% else %}
		{% assign shippingPrice = 790 %}
	{% endif %}
{% else %}
	{% assign shippingPrice = 1000 %}
{% endif %}

{% assign referenced_variant_product = prod %}

{% assign giftsAmount = 0 %}
{% assign faqsAmount = 0 %}
{% for block in blocks %}
	{% case block.type %}
		{% when 'gift' %}
			{% assign show_gift = false %}
			{% if block.settings.show_on == 'both' %}
				{% assign show_gift = true %}
			{% elsif block.settings.show_on == 'global' and isGlobal %}
				{% assign show_gift = true %}
			{% elsif block.settings.show_on == 'us' and isGlobal == false %}
				{% assign show_gift = true %}
			{% endif %}

			{% if show_gift %}
				{% assign giftsAmount = giftsAmount | plus: 1 %}
			{% endif %}

		{% when 'faq' %}
			{% assign faqsAmount = faqsAmount | plus: 1 %}
	{% endcase %}
{% endfor %}

<div
	id="cta-section-{{ SID }}"
	class="cta-section"
	data-default-selection="{{ defaultSelectionIndex }}"
	data-price-format="{{ priceFormat }}"
	data-save-format="{{ saveFormat }}"
	data-price-per="{{ pricePer }}"
	data-thumbs="{{ thumbsLayout }}"
	data-buy-type="{{ buyType }}"
	{% if isOneTimePurchase %}data-one-time-purchase{% endif %}
	{% if isOneTimeGift %}data-one-time-gift{% endif %}
	{% if isSlideVariant %}data-slide-variant{% endif %}
	{% if isPrimeEnabled %}data-buy-with-prime{% endif %}
	{% if isShowReviews %}data-show-reviews{% endif %}
	{% if isProductThumbs %}data-product-thumbs{% endif %}
	{% if isHideThumbs %}data-hide-thumbs{% endif %}
	{% if isHideInfo %}data-hide-info{% endif %}
	{% if isBuyQuantity %}data-buy-quantity{% endif %}>

	<div class="product-actions" data-default-variant-index="{{ defaultSelectionIndex }}" data-gifts-amount="{{ giftsAmount }}">
		<div class="purchase-options flex flex-col gap-3 mb-3">
			<div class="font-semibold text-[18px]">{{ variantsTitle | default: 'Choose your package' }}</div>

			<div class="variant-boxes flex justify-around gap-2">
				{% for block in blocks %}
					{% assign varPurchaseType = block.settings.purchase_type %}
					{% if block.type == 'variant' and varPurchaseType == 'subscribe' %}
						{% assign referenced_variant = blank %}
						{% if isGlobal %}
							{% assign blockVarID = block.settings.variant_id_global | plus: 0 %}
						{% else %}
							{% assign blockVarID = block.settings.variant_id | plus: 0 %}
						{% endif %}

						{% for vari in referenced_variant_product.variants %}
							{% assign currVarID = vari.id | plus: 0 %}

							{% if currVarID == blockVarID %}
								{% assign referenced_variant = vari %}
							{% endif %}
						{% endfor %}

						{% assign var = referenced_variant %}

						{% comment %} Core Variable Assignments {% endcomment %}
						{% assign variant_id = var.metafields.custom.reference_variant_id | default: var.id %}
						{% assign bottle_quantity = var.metafields.my_fields.pack_bottles_quantity %}

						{% comment %} Price Calculations {% endcomment %}
						{% assign original_item_price = var.metafields.custom.original_item.value.price %}
						{% assign original_item_cap = var.metafields.custom.original_item.value.compare_at_price | default: original_item_price %}
						{% assign original_item_cap_total = original_item_cap | times: bottle_quantity %}
						{% assign item_price = var.price | divided_by: bottle_quantity %}

						{% comment %} Savings Calculations {% endcomment %}
						{% assign subscription_save_money = original_item_cap | minus: subscription_item_price %}
						{% assign buy_once_save_money = original_item_cap | minus: item_price %}

						{% comment %} Selling Plan ID Logic {% endcomment %}
						{% if var.metafields.custom.referenced_variant_product_handle %}
							{% assign selling_plan_id = referenced_variant.metafields.subscription.selling_plan_id | default: variant.metafields.subscription.selling_plan_id %}
						{% elsif var.metafields.subscription.selling_plan_id %}
							{% assign selling_plan_id = var.metafields.subscription.selling_plan_id %}
						{% elsif var.selling_plan_allocations.size > 0 %}
							{% assign found_plan = false %}
							{% for allocation in var.selling_plan_allocations %}
								{% if allocation.selling_plan.name contains bottle_quantity %}
									{% assign selling_plan_id = allocation.selling_plan.id %}
									{% assign found_plan = true %}
									{% break %}
								{% endif %}
							{% endfor %}
							{% if found_plan == false %}
								{% assign selling_plan_id = var.selling_plan_allocations.first.selling_plan.id %}
							{% endif %}
						{% endif %}

						{% assign subscription_save_percents = 0 %}
						{% assign subscription_item_price = original_item_cap %}

						{% for allocation in var.selling_plan_allocations %}
							{% assign selling = selling_plan_id | minus: 0 %}
							{% if allocation.selling_plan.id == selling %}
								{% if allocation.compare_at_price %}
									{% assign original_price = allocation.compare_at_price %}
									{% assign discounted_price = allocation.price %}
									{% assign subscription_save_percents = original_price | minus: discounted_price | times: 100 | divided_by: original_price %}
									{% assign mod_5_remainder = subscription_save_percents | modulo: 5 %}
									{% if mod_5_remainder < 3 %}
										{% assign subscription_save_percents = subscription_save_percents | minus: mod_5_remainder %}
									{% else %}
										{% assign subscription_save_percents = subscription_save_percents | plus: 5 | minus: mod_5_remainder %}
									{% endif %}
									{% assign subscription_item_price = discounted_price | divided_by: bottle_quantity %}
								{% else %}
									{% assign subscription_save_percents = 0 %}
									{% assign subscription_item_price = allocation.price | divided_by: bottle_quantity %}
								{% endif %}
							{% endif %}
						{% endfor %}

						{% assign subscription_total_price = subscription_item_price | times: bottle_quantity %}

						{% assign firstMonthDiscount = block.settings.first_month_discount_percentage %}

						<div
						id="variant-box-{{ SID }}-{{ forloop.index }}"
						class="variant-box flex flex-col items-center variant-tab-style text-center w-full {{ varPurchaseType }}"
						data-variant="{{ blockVarID }}"
						data-product="{{ prod.id }}"
						data-original-variant="{{ var.id }}"
						data-subscription-selling-plan-id="{{ selling_plan_id }}"
						data-price="{{ var.price | money_without_currency | replace: ".00", "" }}"
						data-sku="{{ var.sku }}"
						data-index="{{ forloop.index }}"
						data-item-price="{{ item_price }}"
						data-subscription-price="{{ subscription_total_price }}"
						data-subscription-item-price="{{ subscription_item_price }}"
						data-original-item-cap="{{ original_item_cap }}"
						data-dc="{{ var.metafields.custom.discount_code | base64_encode }}"
						data-buy-once-discount="{{ var.metafields.custom.save_percents }}"
						data-subscription-discount="{{ subscription_save_percents }}"
						data-first-month-discount="{{ firstMonthDiscount }}"
						data-price-per="{{ pricePer }}"
						data-bottle-quantity="{{ bottle_quantity }}"
						data-purchase-type="{{ varPurchaseType }}"
						{% if block.settings.allowed_selling_plan_ids != blank %}
						data-allowed-selling-plans="{{ block.settings.allowed_selling_plan_ids | strip | escape }}"
						{% endif %}
							name="track:variant-box|variant-sku:{{ var.sku }}|purchase-type:{{ varPurchaseType }}">
							{% if product.handle == 'curalin' %}
								{% assign subscription_save_percents = var.metafields.subscription.save_percents %}
							{% endif %}
							{% if subscription_save_percents > 0 %}
								<div class="discount mbl:text-[3.5vw] text-white bg-primary font-bold w-full text-[13px] p-1">{{ subscription_save_percents | plus: firstMonthDiscount }}% OFF</div>
							{% endif %}

							<div class="title p-1">
								<span class="font-bold mbl:text-[4vw]">{{ bottle_quantity }} Bottle{% if bottle_quantity > 1 %}s{% endif %}</span>
							</div>

							<div class="md:hidden">
								<span class="title block mbl:text-[3.4vw]"></span>
							</div>
						</div>
					{% endif %}
				{% endfor %}
			</div>

			<div class="price-display">
				<div class="gap-y-2 flex flex-wrap items-end gap-2">
						<div class="final-price flex items-center gap-2">
								<div class="main-price text-primary flex items-end transition-opacity duration-200 ease-in-out">
										{% if priceFormat == 'total' %}
												<span class="price font-bold leading-none text-[30px] mbl:text-[6vw]">{{ subscription_total_price | money }}</span>
										{% else %}
												<span class="price font-bold leading-none text-[30px] mbl:text-[6vw]">{{ subscription_item_price | money }}</span>
												<span class="per-text mt-1 text-[20px]">/bottle</span>
										{% endif %}
								</div>

								<span class="cap self-end text-gray-500 line-through transition-opacity duration-200 ease-in-out">{{ original_item_cap | money }}</span>

								{% if priceFormat == 'total' and subscription_total_price != subscription_item_price %}
										<span class="discount-badge px-4 py-1 text-[16px] font-bold text-white bg-bronze rounded-full transition-opacity duration-200 ease-in-out">SAVE {{ subscription_save_money | money }}</span>
								{% endif %}
						</div>
				</div>

				{% if priceFormat == 'per_bottle' and subscription_total_price != subscription_item_price %}
						<div class="total-line mt-1 text-[16px] h-4 transition-opacity duration-200 ease-in-out">
								Total {{ subscription_total_price | money }}
								<span class="total-price-cap text-gray-500 line-through">{{ original_item_cap_total | money }}</span>
						</div>
				{% endif %}

				<div class="future-price-notice mt-2 text-[14px] text-gray-600 transition-opacity duration-200 ease-in-out"></div>
		</div>

		{% if variantsNotice != blank %}
			<div class="notice text-primary flex gap-2 my-4 text-[15px]">
				<span>ⓘ</span>
				<span>{{ variantsNotice }}</span>
			</div>
		{% endif %}

		<!-- Subscription Frequency Selector with direct Tailwind classes -->
		<div class="subscription-frequency-container hidden my-4 transition-all duration-300 ease-in-out" data-frequency-container>
			<div class="mb-3 font-semibold text-[18px]">Choose delivery frequency</div>
			<div class="subscription-frequency-selector">
				<div id="frequency-options-{{ SID }}" class="flex justify-start gap-2 flex-wrap">
					<!-- Options will be dynamically populated by JavaScript -->
				</div>
			</div>
			<div class="frequency-description text-[14px] text-gray-600 mt-2 transition-opacity duration-300 ease-in-out leading-normal min-h-[24px]"><!-- Frequency description will be populated by JavaScript --></div>
		</div>

		{% render 'subscription-box-faq',
			SID: SID,
			faqsAmount: faqsAmount,
			blocks: blocks
		%}

		{% render 'subscription-box-gift-selector',
			SID: SID,
			giftsAmount: giftsAmount,
			blocks: blocks,
			isGlobal: isGlobal
		%}

		<div class="submit-wrap flex flex-col w-full">
			<div class="checkout-button">
				{% assign buttonSID = SID | append: '-checkout' %}
				{% if buyType == 'buy_now' %}{% assign ctaButtonTitle = 'Get Started' %}{% else %}{% assign ctaButtonTitle = 'Add To Cart' %}{% endif %}

				{% render 'buy-buttons-new-4-old',
					SID: buttonSID,
					product: prod,
					variant: '',
					buttonText: ctaButtonTitle,
					selling_plan_id: selling_plan_id,
					product_form_id: product_form_id,
					buyType: buyType,
					isBuyWithPrime: isBuyWithPrime,
					buyboxType: buyboxType,
					buyboxName: buyboxName
				%}
			</div>

			<div class="one-time-purchase-link mt-3 text-center">
				{% if isOneTimePurchaseLink %}
					{% assign firstVariant = prod.selected_or_first_available_variant %}
					<div
						id="one-time-add-to-cart"
						class="one-time-add-to-cart variant-box text-primary mb-2 underline cursor-pointer"
						name="track:link-submit|buybox-type:{{ buyboxType }}|buybox-name:{{ buyboxName }}|variant-sku:{{ firstVariant.sku }}|purchase-type:buyonce"
						data-variant-id="{{ firstVariant.id }}"
						data-bottle-quantity="1"
						data-sku="{{ firstVariant.sku }}"
						data-purchase-type="buyonce">
						Buy Once for {{ firstVariant.price | money }} + {{ shippingPrice | money | replace: '.00', '' }} Shipping
					</div>
				{% endif %}
			</div>

			{% if blocks.size > 0 %}
				{% for block in blocks %}
					{% if block.type == 'text' %}
						<div class="text-content text-[14px] text-primary whitespace-break-spaces {% if block.settings.text_position == 'center' %}text-center{% else %}text-start{% endif %}">{{ block.settings.content }}</div>
					{% endif %}
				{% endfor %}
			{% endif %}
		</div>
	</div>
</div>

<!-- For supporting old styles but with Tailwind classes, hidden by default -->
<div class="buy-box grid grid-cols-[45%_40%] gap-x-[5%] justify-center hidden">
</div>

<style>
	/* Core variables - keep these as CSS variables */
	#cta-section-{{ SID }} {
			--text-color: #4a5568;
			--border-color: #cbcbcb;
			--radio-size: 1em;
			--radio-size-mobile: 1em;
			--transition-speed: 0.2s;

			/* Variant Tab Styles */
			.variant-box.variant-tab-style,
			.frequency-option.variant-tab-style {
					border-width: 2px;
					border-color: var(--primary-color);
					border-radius: 0.375rem;
					cursor: pointer;
					align-content: center;
					transition: all 0.3s ease;

					&.selected {
							background-color: var(--primary-color);
							color: white;

							.discount {
									background-color: var(--orange);
									color: var(--primary-color);
									transition: all 0.3s ease;
							}
					}

					&:not(.selected):hover {
						background-color: var(--bg-color);
					}
			}

			/* Frequency selector styles */
			.subscription-frequency-container {
				margin-top: 16px;
				margin-bottom: 16px;
			}

			.frequency-option {
				min-width: 100px;
				background-color: var(--bg-color);
				color: var(--primary-color);
			}

			/* Product Actions - Keep these custom grid areas */
			.product-actions {
					grid-area: {% if isHideInfo %}1{% else %}2{% endif %}/2/3/3;
			}

			/* Radio Input Styles */
			.radio-input {
					display: flex;
					align-items: center;
					justify-content: center;
					position: relative;

					input[type='radio'] {
							&:hover,
							.variant-box:hover & {
									transform: scale(1.1);
									cursor: pointer;
									transition: 0.1s all;
							}
					}
			}

			/* Price Display Component */
			.price-display {
					.price-content-transition,
					.description-transition {
							transition: opacity 400ms ease-in-out;
					}

					.flex.items-end,
					.mt-2 {
							will-change: opacity;
					}

					/* Price Elements */
					.main-price,
					.discount-badge,
					.total-line {
							transition: opacity 200ms ease-in-out;
							will-change: opacity;
							opacity: 1;
					}
			}

			/* Animation States */
			.fade-out {
					opacity: 0 !important;
			}

			.fade-in {
					opacity: 1 !important;
			}

			/* Responsive Styles */
			@media (max-width: 1269px) {
					.variant-box {
							width: 100%;
					}
			}

			@media (max-width: 767px) {
					.product-actions {
							grid-area: unset;
							grid-row: 3;
							max-width: unset;
							min-height: unset;
					}

					.one-time-purchase-link {
							.one-time-add-to-cart {
									font-size: 4vw;
							}
					}
			}
	}
</style>

<!-- Load buy-box.js script if not already loaded -->
<script>
	document.addEventListener('DOMContentLoaded', function() {
		console.log('Initializing buy-box-subscription-4-optimized-2, SID: {{ SID }}');

		// Load the buy-box.js script if not already loaded
		if (!window.CuralifeBoxes || !window.CuralifeBoxes.initialized) {
			const script = document.createElement('script');
			script.src = "{{ 'buy-box.js' | asset_url }}";
			script.async = true;
			document.head.appendChild(script);

			// Initialize after script loads
			script.onload = function() {
				if (window.CuralifeBoxes) {
					// Initialize all buy boxes on the page
					window.CuralifeBoxes.initAll();

					// Give some time for initialization then ensure the product variant data is available
					setTimeout(function() {
						initializeProductData('{{ SID }}');
					}, 300);
				}
			};
		} else {
			// Script already loaded, just ensure product data is available
			initializeProductData('{{ SID }}');
		}

		/**
		 * Ensures the product data is available for variants
		 * This is critical for frequency options to work properly
		 */
		function initializeProductData(SID) {
			const section = document.getElementById(`cta-section-${SID}`);
			if (!section) return;

			// Get selected variant box
			const selectedBox = section.querySelector('.variant-box.selected') || section.querySelector('.variant-box');
			if (!selectedBox) return;

			const productId = selectedBox.dataset.product;
			const variantId = selectedBox.dataset.variant;

			// Only initialize if we have both IDs
			if (!productId || !variantId) return;

			// Create product data structure if it doesn't exist
			if (!window.productData) window.productData = {};

			// Key step: Make the product data available to buy-box.js
			// This is crucial for frequency options to render correctly
			if (!window.productData[productId]) {
				// Initialize with basic structure that buy-box.js expects
				window.productData[productId] = {
					id: productId,
					variants: [],
					initialized: false
				};
			}

			// Get all variant boxes for this product
			const allVariantBoxes = section.querySelectorAll('.variant-box');

			// Extract variant information from available boxes
			allVariantBoxes.forEach(box => {
				const boxVariantId = parseInt(box.dataset.variant);
				const boxProductId = box.dataset.product;

				// Skip if not matching our product
				if (boxProductId !== productId) return;

				// Skip if variant already exists
				if (window.productData[productId].variants.some(v => v.id === boxVariantId)) return;

				// Extract bottle quantity for frequency recommendation
				const bottleQuantity = parseInt(box.dataset.bottleQuantity || '1');

				// Create a basic variant structure
				const variantData = {
					id: boxVariantId,
					title: `${bottleQuantity} Bottle${bottleQuantity > 1 ? 's' : ''}`,
					price: parseFloat(box.dataset.price || '0') * 100, // convert to cents
					sku: box.dataset.sku || '',
					selling_plan_allocations: []
				};

				// Check if this is a subscription variant
				if (box.dataset.purchaseType === 'subscribe') {
					// Check if the box has allowed selling plans
					const allowedSellingPlansStr = box.dataset.allowedSellingPlans;

					// Default selling plan from the box
					const defaultSellingPlanId = box.dataset.subscriptionSellingPlanId;

					console.log('Variant box data:', {
						boxId: box.id,
						variantId: boxVariantId,
						defaultSellingPlanId,
						allowedSellingPlans: allowedSellingPlansStr || 'none specified'
					});

					if (allowedSellingPlansStr && allowedSellingPlansStr.trim()) {
						// Parse allowed selling plan IDs
						const allowedPlans = allowedSellingPlansStr
							.split(',')
							.map(id => id.trim())
							.filter(id => id && !isNaN(parseInt(id)));

						console.log('Found allowed selling plans:', allowedPlans);

						// Add each allowed selling plan to the variant's allocations
						allowedPlans.forEach((planId, index) => {
							// Create descriptive name based on bottle quantity and frequency
							// For allowed plans other than the default, we'll create variations
							const isDefault = planId === defaultSellingPlanId;
							let planName;

							// For the default one, use the bottle quantity as months
							if (isDefault) {
								planName = `${bottleQuantity} Month${bottleQuantity > 1 ? 's' : ''}`;
							} else {
								// For others, create alternative frequencies
								// This is an estimation - in a real scenario, you'd know the actual frequencies
								const frequencies = [30, 60, 90]; // days
								const frequency = frequencies[index % frequencies.length];
								planName = `${frequency} Days`;
							}

							variantData.selling_plan_allocations.push({
								selling_plan: {
									id: planId,
									name: planName
								},
								price: parseFloat(box.dataset.subscriptionPrice || '0') * 100,
								compare_at_price: parseFloat(box.dataset.originalItemCap || '0') * 100 * bottleQuantity
							});
						});
					} else if (defaultSellingPlanId) {
						// If no allowed plans specified but we have a default one
						variantData.selling_plan_allocations.push({
							selling_plan: {
								id: defaultSellingPlanId,
								name: `${bottleQuantity} Month${bottleQuantity > 1 ? 's' : ''}`
							},
							price: parseFloat(box.dataset.subscriptionPrice || '0') * 100,
							compare_at_price: parseFloat(box.dataset.originalItemCap || '0') * 100 * bottleQuantity
						});
					}
				}

				// Add to product data
				window.productData[productId].variants.push(variantData);
			});

			// Mark as initialized
			window.productData[productId].initialized = true;

			console.log('Product data initialized for SID:', SID);
			console.log('Product data structure:', window.productData[productId]);

			// Set up frequency options functionality
			setupFrequencyOptions(SID);

			// If CuralifeBoxes is initialized, re-select the variant box to trigger frequency options
			if (window.CuralifeBoxes && window.CuralifeBoxes.instances && window.CuralifeBoxes.instances[SID]) {
				// Trigger selection of the appropriate box
				const boxInstance = window.CuralifeBoxes.instances[SID];
				if (boxInstance.togglePurchaseBox && selectedBox) {
					console.log('Triggering box selection to initialize frequency options');

					// Give the system time to process
					setTimeout(() => {
						boxInstance.togglePurchaseBox(selectedBox);
					}, 100);
				}
			}
		}

		// Setup frequency options functionality
		function setupFrequencyOptions(SID) {
			const section = document.getElementById(`cta-section-${SID}`);
			if (!section) return;

			// Add the frequency selection functionality
			section.addEventListener('click', function(e) {
				const frequencyOption = e.target.closest('#frequency-options-' + SID + ' > div');
				if (!frequencyOption) return;

				selectFrequencyOption(frequencyOption, SID);
			});

			// Add a function to populate the frequency selector based on selected variant
			section.querySelectorAll('.variant-box').forEach(box => {
				box.addEventListener('click', function() {
					setTimeout(() => populateFrequencySelector(this, SID), 50);
				});
			});

			// Initial population for selected box
			const selectedBox = section.querySelector('.variant-box.selected') || section.querySelector('.variant-box');
			if (selectedBox) {
				populateFrequencySelector(selectedBox, SID);
			}
		}

		// Function to handle frequency option selection
		function selectFrequencyOption(option, SID) {
			const section = document.getElementById(`cta-section-${SID}`);
			if (!section) return;

			// Get all options in the container
			const allOptions = option.parentElement.querySelectorAll('div');

			// Update the visual state of all options
			allOptions.forEach(opt => {
				opt.classList.remove('selected');
			});

			option.classList.add('selected');

			// Update the form field and selected box with new selling plan ID
			const sellingPlanId = option.dataset.sellingPlanId;
			const submitSellingPlanId = section.querySelector('.submit-selling-plan-id');
			const selectedBox = section.querySelector('.variant-box.selected');

			if (submitSellingPlanId) {
				submitSellingPlanId.value = sellingPlanId;
			}

			if (selectedBox) {
				selectedBox.dataset.subscriptionSellingPlanId = sellingPlanId;
			}

			// Update the frequency description
			updateFrequencyDescription(SID);
		}

		// Function to update the frequency description text
		function updateFrequencyDescription(SID) {
			const section = document.getElementById(`cta-section-${SID}`);
			if (!section) return;

			const descriptionEl = section.querySelector('.frequency-description');
			if (!descriptionEl) return;

			const frequencyOptions = section.querySelector('#frequency-options-' + SID);
			if (!frequencyOptions) return;

			const selectedOption = frequencyOptions.querySelector('.selected');

			if (!selectedOption) return;

			const selectedFrequencyValue = parseInt(selectedOption.dataset.frequencyValue || '1', 10);
			const selectedFrequencyUnit = selectedOption.dataset.frequencyUnit || 'month';
			const selectedBox = section.querySelector('.variant-box.selected');
			const bottleQuantity = parseInt(selectedBox?.dataset.bottleQuantity || '1', 10);

			let description = '';

			// If selected frequency matches recommended frequency (only for months)
			if (selectedFrequencyUnit === 'month' && selectedFrequencyValue === bottleQuantity) {
				description = ''; // No text when on recommended frequency
			} else {
				// Otherwise show the recommendation
				description = `Recommended - every ${bottleQuantity} month${bottleQuantity > 1 ? 's' : ''}`;
			}

			// Animate the description update
			descriptionEl.style.opacity = '0';
			setTimeout(() => {
				descriptionEl.innerHTML = description;
				descriptionEl.style.opacity = '1';
			}, 200);
		}

		// Function to extract frequency value and unit from plan name
		function extractFrequency(planName) {
			// Try matching days pattern first
			let daysMatch = planName.match(/(\d+)\s*Day/i);
			if (daysMatch) {
				return {
					value: parseInt(daysMatch[1], 10),
					unit: 'day'
				};
			}

			// Try matching months pattern
			let monthsMatch = planName.match(/(\d+)\s*Month/i);
			if (monthsMatch) {
				return {
					value: parseInt(monthsMatch[1], 10),
					unit: 'month'
				};
			}

			// Default fallback
			return { value: 1, unit: 'month' };
		}

		// Function to populate frequency options based on the selected variant
		function populateFrequencySelector(el, SID) {
			try {
				const section = document.getElementById(`cta-section-${SID}`);
				if (!section) return;

				// Use the data attribute for more specific selection
				const frequencyContainer = section.querySelector('[data-frequency-container]');
				if (!frequencyContainer) return;

				const frequencyOptions = section.querySelector('#frequency-options-' + SID);
				if (!frequencyOptions) return;

				const variant = el.dataset.originalVariant || el.dataset.variant;
				const isSub = el.dataset.purchaseType === 'subscribe';
				const bottleQuantity = parseInt(el.dataset.bottleQuantity || '1', 10);

				if (!isSub) {
					frequencyContainer.classList.add('hidden');
					return;
				}

				const productId = el.dataset.product;
				const variantId = parseInt(variant);
				const hasAllowedSellingPlans = el.dataset.allowedSellingPlans && el.dataset.allowedSellingPlans.trim() !== '';

				console.log('Populating frequency selector:', {
					productId,
					variant,
					bottleQuantity,
					hasAllowedSellingPlans
				});

				// Try to find the variant in product data
				let selectedVariant = null;
				if (window.productData && window.productData[productId]) {
					const product = window.productData[productId];
					if (product.variants) {
						// First try exact match
						selectedVariant = product.variants.find(v => v.id === variantId);

						if (!selectedVariant) {
							console.log('Variant not found in product data. Available variants:', product.variants.map(v => v.id));

							// Try original variant as fallback
							const originalVariantId = parseInt(el.dataset.originalVariant || '0');
							if (originalVariantId > 0) {
								selectedVariant = product.variants.find(v => v.id === originalVariantId);

								if (selectedVariant) {
									console.log('Found variant using original variant ID fallback');
								}
							}
						}
					}
				}

				if (!selectedVariant) {
					console.log('Variant not found in product data, using fallback');
					handleFallbackFrequencyOptions(el, frequencyOptions, frequencyContainer, SID);
					return;
				}

				// Check if variant has selling plan allocations
				if (!selectedVariant.selling_plan_allocations || selectedVariant.selling_plan_allocations.length === 0) {
					console.warn('Selected variant has no selling plan allocations:', selectedVariant.id);
					handleFallbackFrequencyOptions(el, frequencyOptions, frequencyContainer, SID);
					return;
				}

				// If we have allowed selling plans, filter to only use those
				let sellingPlanAllocations = [...selectedVariant.selling_plan_allocations];

				// Find selling plan that matches the bottle quantity (recommended frequency)
				let recommendedSellingPlanId = '';

				if (selectedVariant.selling_plan_allocations) {
					for (const allocation of selectedVariant.selling_plan_allocations) {
						const { value, unit } = extractFrequency(allocation.selling_plan.name);

						// If unit is months and matches bottle quantity
						if (unit === 'month' && value === bottleQuantity) {
							recommendedSellingPlanId = allocation.selling_plan.id.toString();
							break;
						}
					}
				}

				// If we found a recommended selling plan, set it as the current
				if (recommendedSellingPlanId && !el.dataset.subscriptionSellingPlanId) {
					el.dataset.subscriptionSellingPlanId = recommendedSellingPlanId;
				}

				// Build frequency options
				frequencyOptions.innerHTML = '';
				const currentSellingPlanId = el.dataset.subscriptionSellingPlanId;
				const fragment = document.createDocumentFragment();

				// Convert frequency to days for sorting
				const getAllocationDays = (allocation) => {
					if (!allocation || !allocation.selling_plan) return 30; // default
					const { value, unit } = extractFrequency(allocation.selling_plan.name);
					return unit === 'day' ? value : value * 30; // approximate month as 30 days
				};

				// Sort allocations by frequency in days (ascending)
				sellingPlanAllocations.sort((a, b) => {
					return getAllocationDays(a) - getAllocationDays(b);
				});

				// Filter out original plan if using allowed selling plans
				if (hasAllowedSellingPlans) {
					const allowedPlans = el.dataset.allowedSellingPlans
						.split(',')
						.map(id => id.trim())
						.filter(id => id && !isNaN(parseInt(id)));

					sellingPlanAllocations = sellingPlanAllocations.filter(allocation =>
						allowedPlans.includes(allocation.selling_plan.id.toString()));
				}

				sellingPlanAllocations.forEach(allocation => {
					if (!allocation || !allocation.selling_plan) return;

					const plan = allocation.selling_plan;

					// Extract frequency value and unit from plan name
					const { value, unit } = extractFrequency(plan.name);

					const frequencyBox = document.createElement('div');
					frequencyBox.className = 'frequency-option variant-tab-style rounded-md cursor-pointer py-2 px-4 min-w-[90px] text-center transition-all duration-300 ease-in-out';

					// Set data attributes
					frequencyBox.dataset.sellingPlanId = plan.id;
					frequencyBox.dataset.frequencyValue = value;
					frequencyBox.dataset.frequencyUnit = unit;

					// Set the current selling plan ID to recommended months if it's a new selection
					// or keep existing selection if it was already set
					const isRecommendedMonthPlan = (unit === 'month' && value === bottleQuantity);
					const shouldSelectRecommended = !currentSellingPlanId || isRecommendedMonthPlan;

					if ((plan.id && plan.id.toString() === currentSellingPlanId) ||
						(shouldSelectRecommended && isRecommendedMonthPlan && !hasAllowedSellingPlans)) {
						frequencyBox.classList.add('selected');

						// Update the current box with the recommended selling plan ID
						if (shouldSelectRecommended && isRecommendedMonthPlan && !hasAllowedSellingPlans) {
							el.dataset.subscriptionSellingPlanId = plan.id.toString();
							const submitSellingPlanId = section.querySelector('.submit-selling-plan-id');
							if (submitSellingPlanId) {
								submitSellingPlanId.value = plan.id.toString();
							}
						}
					}

					// Change label format based on the frequency unit
					let displayText = '';
					if (unit === 'day') {
						displayText = value === 1 ? 'Every Day' : `Every ${value} Days`;
					} else { // month
						displayText = value === 1 ? 'Every Month' : `Every ${value} Months`;
					}

					frequencyBox.innerHTML = `
						<div class="p-1">
							<span class="font-semibold">${displayText}</span>
						</div>
					`;

					fragment.appendChild(frequencyBox);
				});

				// Make sure we select the first option if no option is selected
				if (fragment.children.length > 0 && !fragment.querySelector('.selected')) {
					const firstOption = fragment.children[0];
					firstOption.classList.add('selected');

					// Update the selected selling plan
					el.dataset.subscriptionSellingPlanId = firstOption.dataset.sellingPlanId;
					const submitSellingPlanId = section.querySelector('.submit-selling-plan-id');
					if (submitSellingPlanId) {
						submitSellingPlanId.value = firstOption.dataset.sellingPlanId;
					}
				}

				frequencyOptions.appendChild(fragment);
				frequencyContainer.classList.remove('hidden');

				// Update the description
				updateFrequencyDescription(SID);
			} catch (error) {
				console.error('Error in populateFrequencySelector:', error);
				handleFallbackFrequencyOptions(el, frequencyOptions, frequencyContainer, SID);
			}
		}

		function handleFallbackFrequencyOptions(el, frequencyOptions, frequencyContainer, SID) {
			if (!frequencyOptions || !frequencyContainer) return;

			if (el.dataset.purchaseType === 'subscribe') {
				const bottleQuantity = parseInt(el.dataset.bottleQuantity || '1', 10);
				const currentSellingPlanId = el.dataset.subscriptionSellingPlanId;

				if (currentSellingPlanId) {
					frequencyOptions.innerHTML = '';
					const fallbackBox = document.createElement('div');
					fallbackBox.className = 'frequency-option variant-tab-style selected rounded-md cursor-pointer py-2 px-4 min-w-[90px] text-center transition-all duration-300 ease-in-out';
					fallbackBox.dataset.sellingPlanId = currentSellingPlanId;
					fallbackBox.dataset.frequencyValue = bottleQuantity.toString();
					fallbackBox.dataset.frequencyUnit = 'month'; // Default to months
					fallbackBox.innerHTML = `
						<div class="p-1">
							<span class="font-semibold">Every ${bottleQuantity} Month${bottleQuantity > 1 ? 's' : ''}</span>
						</div>
					`;
					frequencyOptions.appendChild(fallbackBox);
					frequencyContainer.classList.remove('hidden');

					// Update description
					setTimeout(() => updateFrequencyDescription(SID), 100);
				} else {
					frequencyContainer.classList.add('hidden');
				}
			} else {
				frequencyContainer.classList.add('hidden');
			}
		}
	});
</script>